apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: authentik
spec:
  interval: 5m
  chart:
    spec:
      chart: authentik
      version: ">=2025.0.0-0"
      sourceRef:
        kind: HelmRepository
        name: goauthentik
        namespace: flux-system
  values:
    authentik:
      # secret_key is injected via valuesFrom below
      error_reporting:
        enabled: true
      postgresql:
        # password is injected via valuesFrom
        # other connection params use chart defaults when bundled Postgres is enabled
        {}

    # TRAEFIK + PLAIN HTTP AT ORIGIN (Cloudflare Tunnel handles TLS)
    server:
      ingress:
        enabled: true
        ingressClassName: traefik
        hosts:
        - auth.${BASE_DOMAIN}
        - auth.homelab
        annotations:
          # Optional: keep TLS off at origin so CF Tunnel speaks HTTP to Traefik
          traefik.ingress.kubernetes.io/router.entrypoints: web

    # Bundle Postgres & Redis 
    postgresql:
      enabled: true
      auth:
        # password injected via valuesFrom
        {}
      primary:
        persistence:
          enabled: true
          size: 8Gi

    redis:
      enabled: true

  valuesFrom:
  - kind: Secret
    name: authentik-secret
    valuesKey: AUTHENTIK_SECRET_KEY
    targetPath: authentik.secret_key
  - kind: Secret
    name: authentik-secret
    valuesKey: POSTGRES_PASSWORD
    targetPath: postgresql.auth.password
  - kind: Secret
    name: authentik-secret
    valuesKey: POSTGRES_PASSWORD
    targetPath: authentik.postgresql.password
