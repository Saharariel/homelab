apiVersion: apps/v1
kind: Deployment
metadata:
  name: qbittorrent
  labels:
    app: qbittorrent
spec:
  replicas: 1
  selector:
    matchLabels:
      app: qbittorrent
  template:
    metadata:
      labels:
        app: qbittorrent
    spec:
      containers:
      - name: gluetun
        image: qmcgaw/gluetun:v3
        securityContext:
          capabilities:
            add: ["NET_ADMIN"]
        env:
          - name: VPN_SERVICE_PROVIDER
            value: "nordvpn"  # or your VPN provider

          - name: OPENVPN_USER
            valueFrom:
              secretKeyRef:
                name: vpn-creds
                key: username

          - name: OPENVPN_PASSWORD
            valueFrom:
              secretKeyRef:
                name: vpn-creds
                key: password

          - name: SERVER_COUNTRIES
            value: "Israel"  # or your preferred country
          - name: FIREWALL
            value: "on"  # optional: killswitch
          - name: QBITTORRENT_ENABLED
            value: "on"  # enable embedded qbittorrent
          - name: QBITTORRENT_WEBUI_PORT
            value: "8081"

        ports:
          - containerPort: 8888  # HTTP proxy
          - containerPort: 8388  # Shadowsocks TCP
            protocol: TCP
          - containerPort: 8388  # Shadowsocks UDP
            protocol: UDP
          - containerPort: 8081  # qbittorrent
          
        volumeMounts:
          - name: gluetun-config
            mountPath: /gluetun
          - name: dev-net-tun
            mountPath: /dev/net/tun

      - name: qbittorrent
        image: lscr.io/linuxserver/qbittorrent:4.6.0
        env:
          - name: WEBUI_PORT
            value: "8081"
          - name: PUID
            value: "1000"
          - name: PGID
            value: "1000"
        ports:
          - containerPort: 8081 
        volumeMounts:
          - name: downloads
            mountPath: /data/torrent/
          - name: qbittorrent-config
            mountPath: /config

      volumes:
        - name: gluetun-config
          hostPath:
          path: /mnt/data/configs/glueten
          type: Directory

        - name: dev-net-tun
          hostPath:
            path: /dev/net/tun
            type: CharDevice

        - name: qbittorrent-config
          hostPath:
          path: /mnt/data/configs/qbittorrent/appdata
          type: Directory

        - name: downloads
          hostPath:
          path: /mnt/data/torrent/
          type: Directory
